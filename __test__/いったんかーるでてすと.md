#!/bin/bash

echo "=== カート機能完全テスト ==="

# 1. 一般ユーザーでログイン
echo "1. 一般ユーザーでログイン中..."
USER_TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/signin \
  -H "Content-Type: application/json" \
  -d '{"email": "john@example.com", "password": "UserPass123"}' | \
  jq -r '.token')

echo "取得したユーザートークン: $USER_TOKEN"

# 2. 新しいカートを作成
echo "2. 新しいカートを作成中..."
CART_RESPONSE=$(curl -s -X POST http://localhost:3000/api/carts \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "userId": 2,
    "itemId": 2,
    "quantity": 5
  }')

echo "カート作成レスポンス: $CART_RESPONSE"

# 3. 作成したカートのIDを取得
CART_ID=$(echo $CART_RESPONSE | jq -r '.id')

# 4. 作成したカートを取得
echo "3. 作成したカートを取得中..."
curl -s -X GET http://localhost:3000/api/carts/$CART_ID \
  -H "Authorization: Bearer $USER_TOKEN" | jq '.'

# 5. カートを更新
echo "4. カートを更新中..."
curl -s -X PUT http://localhost:3000/api/carts/$CART_ID \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "userId": 2,
    "itemId": 2,
    "quantity": 8
  }' | jq '.'

# 6. 管理者でログイン
echo "5. 管理者でログイン中..."
ADMIN_TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/admin/signin \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@lh.sandbox", "password": "pass"}' | \
  jq -r '.token')

# 7. 全カート一覧を取得（管理者のみ）
echo "6. 全カート一覧を取得中..."
curl -s -X GET http://localhost:3000/api/carts \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq '.'

echo "=== テスト完了 ==="